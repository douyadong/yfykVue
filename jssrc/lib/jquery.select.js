/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房移动端FE-MVC框架
 2. 页面名称：select (jQuery插件 - 下拉选择)
 3. 作者：zhaohuagang@lifang.com
 4. 实例：
    $("input").select({
        "title" : "请选择爱好" ,
        "options" : [
            { "text" : "足球" , "value" : "football" } ,
            { "text" : "篮球" , "value" : "basketball" } ,
            { "text" : "音乐" , "value" : "music" } ,
            { "text" : "旅游" , "value" : "tour" } ,
            { "text" : "打架" , "value" : "war" } ,
            { "text" : "计算机" , "value" : "computer" }
        ] ,
        "valueUnionSelector" : "#selectedInterest" ,
        "multiple" : true ,
        "least" : 2 ,
        "most" : 3
    }) ;
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.select = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个select加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.select.defaults, options);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            var handle = this ;
            $(this).click(function(event){
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                点击句柄的时候先关掉先前的下拉框，在重新弹开
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $.fn.select.close(opts) ;
                window.setTimeout(function(){
                    $.fn.select.open(handle, opts) ;
                }, opts.toggleSpeed) ;               
            }) ;
        });
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    弹开下拉容器
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.select.open = function(handle, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制工具栏
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var $toolbar = $(document.createElement("DIV")).addClass("select-toolbar").append("<h5>" + opts.title + "</h5>") ;
        var $confirmBtn = $(document.createElement("A")).attr("href", "javascript:void(0);").addClass("confirm").text("确定") ;
        $confirmBtn.click(function(){
            $.fn.select.confirm(handle, opts) ;
        }) ;
        $toolbar.append($confirmBtn) ;
        var $cancelBtn = $(document.createElement("A")).attr("href", "javascript:void(0);").addClass("cancel").text("取消") ;
        $cancelBtn.click(function(){
            $.fn.select.close(opts) ;
        }) ;
        $toolbar.append($cancelBtn) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将原先句柄原本选中的 label和 value拆分成数组
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var selectedLabels = $.trim($(handle).val().toString()) ;
        var selectedValues = $.trim($(opts.valueUnionSelector).val().toString()) ;
        var selectedLabelArray = new Array ;
        var selectedValueArray = new Array ;
        if(selectedLabels !== "") {
            selectedLabelArray = selectedLabels.split(opts.separator) ;
            selectedValueArray = selectedValues.split(opts.separator) ;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制选项容器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var $itemsContainer = $(document.createElement("DIV")).addClass("select-items") ;
        var options = opts.options ;
        for(var a = 0 ; a < options.length ; a ++) {            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据当前选项的value是否在选中项来决定选中标识的class
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var className = ($.inArray(options[a].value, selectedValueArray) !== -1) ? opts.selectedIconClassName : "" ;           
            var $option = $(document.createElement("A")).attr("href", "javascript:void(0);").attr("data-value", options[a].value).append("<label>" + options[a].text + "</label><i class=\"iconfont " + className + "\"></i>") ;           
            $option.click(function() {
                var selected = $(this).find("." + opts.selectedIconClassName).size() > 0 ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                如果不允许多选，还要将其他选中项取消选择
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                if( ! opts.multiple) $(".wkzf-select .select-items a .iconfont").removeClass(opts.selectedIconClassName) ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                最后切换自己内部标识
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                if(selected) $(this).find(".iconfont").removeClass(opts.selectedIconClassName) ;
                else $(this).find(".iconfont").addClass(opts.selectedIconClassName) ;
                
            }) ;            
            $itemsContainer.append($option) ;
        }
        var $select = $(document.createElement("DIV")).addClass("wkzf-select").append($toolbar).append($itemsContainer) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        把整个dom节点贴到 document.body下
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(document.body).append($select) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        显示并移动到bottom : 0 的位置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $select.show().animate({ "bottom" : 0 }, opts.toggleSpeed) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    关闭select
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.select.close = function(opts) {
        if($(".wkzf-select").size() === 0) return ;
        $(".wkzf-select").animate({ "bottom" : "-19rem" }, opts.toggleSpeed).remove() ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    点击确定按钮执行的任务
    @handle : 弹开下拉框的句柄    
    @opts : 参数值
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.select.confirm = function(handle, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        首先对是否可以多选，最少选择多少，最多选择多少进行判断
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var selectedAmount = $(".wkzf-select .select-items a ." + opts.selectedIconClassName).size() ;
        if(opts.multiple) {
            if(selectedAmount < opts.least) {
                $.tips("至少选择 " + opts.least + " 项！", 3) ;
                return ;
            }
            else if(selectedAmount > opts.most) {                
                $.tips("最多选择 " + opts.most + " 项！", 3) ;
                return ;
            }
        }        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        然后进行值的组合
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var unionLabel = "" ;
        var unionValue = "" ;
        $(".wkzf-select .select-items a").each(function(key, element){
            if($(element).find("." + opts.selectedIconClassName).size() > 0) {
                if(unionLabel !== "") unionLabel += opts.separator ;
                unionLabel += $(element).find("label").text() ;
                if(unionValue !== "") unionValue += opts.separator ;
                unionValue += $(element).attr("data-value") ;
            }
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        把组合好的值写到相应的input框中，然后关闭下拉选择框
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(handle).val(unionLabel) ;
        $(opts.valueUnionSelector).val(unionValue) ;  
        $.fn.select.close(opts) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     select默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.select.defaults = {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        title信息
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "title" : "请选择" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选项信息
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "options" : [] ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否支持多选，默认是不支持
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "multiple" : false ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        至少要选择多少项
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "least" : 1 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        至多要选择多少项
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "most" : 3 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹开或者收起速度，可以是毫秒数，也可以是 fast | normal | slow等字符串
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "toggleSpeed" : 200 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中的label和value连起来的分隔符
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "separator" : "," ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中的value合并起来后存放到选择器表示的表单元素的值中
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "valueUnionSelector" : "" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中标识的字体图标class名称
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "selectedIconClassName" : "icon-gouxuan"
    } ;
})(jQuery) ;