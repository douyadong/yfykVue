/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房移动端FE-MVC框架
 2. 页面名称：upload (jQuery插件 - 文件上传)
 3. 作者：zhaohuagang@lifang.com
 4. 实例：
    $(".portrait-uploader").upload({
        "accept" : "image/jpg,image/jpeg,image/png,image/gif" ,
        "multiple" : true
    }) ;
 5. 在一个容器内增加文件上传缩略图及句柄
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.upload = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个upload加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.upload.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
           $.fn.upload.generate(this, opts) ;
        }) ;
    } ;   
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绘制相应的dom节点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.upload.generate = function(container, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        给容器加上wkzf-uploader这个class
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(container).addClass("wkzf-uploader") ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制存放缩略图或者文件名清单的ul容器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var $uploaderFiles = $(document.createElement("UL")).addClass("uploader-files") ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制上传句柄
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var $uploaderHandle = $(document.createElement("DIV")).addClass("uploader-handle dashed-box") ;
        var $input = $(document.createElement("INPUT")).addClass("wkzf-uploader-input").attr("type", "file").attr("multiple", "").attr("accept", opts.accept) ;
        $uploaderHandle.append($input) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制移除图片句柄
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var $removeHandle = $(document.createElement("DIV")).addClass("dashed-box remove-handle").append("<i class=\"iconfont icon-shanchu\"></i>") ;
        $removeHandle.click(function(){
            var $selectedFiles = $(container).find(".uploader-files li.on") ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
           没有选中的文件就提示
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if($selectedFiles.size() === 0) {
                $.tips("请先点击选择文件！", 3) ;
                return false ;
            }
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
           移除选中的文件
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $selectedFiles.remove() ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
           如果没有了缩略图就连移除句柄也隐藏 
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if($(container).find(".uploader-files li").size() === 0) $(container).find(".remove-handle").hide() ;
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        吧相应的dom节点贴到容器下
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(container).append($uploaderFiles).append($uploaderHandle).append($removeHandle) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        当上传句柄文件域值改变的时候触发事件监听
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $input.change(function() {
            var reader = new FileReader() ;
            reader.readAsDataURL(this.files[0]) ;           
            reader.onload = function() {                
                $.fn.upload.compressAttach(this.result, container, opts) ;                
            } ;            
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    图片压缩处理
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.upload.compressAttach = function(res, container, opts) {
        var img = new Image() ;
        img.src = res ;
        img.onload = function() {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            创建一个用于压缩图片的canvas
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var cvs = document.createElement("canvas") ;
            var ctx = cvs.getContext("2d") ;
            var width = img.width / 2 ;
            var height = img.height / 2 ;
            cvs.width = width ;
            cvs.height = height ;
            ctx.fillStyle = "#fff" ;
            ctx.fillRect(0, 0, cvs.width, cvs.height) ;
            ctx.drawImage(img, 0, 0, width, height) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            进行最小压缩
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var data = cvs.toDataURL("image/jpeg", 0.5) ;
            var imagedata = encodeURIComponent(data.split(",")[1]) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            设置缩略图背景并把相应img数据绑到相应的li节点上
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var $li = $(document.createElement("LI")).css({ "background-image" : "url(" + res + ")" }).attr("data-img", imagedata) ;
            var $selectedHandle = $(document.createElement("DIV")).addClass("selected-handle").append("<i class=\"iconfont icon-gouxuan\"></i>") ;
            $li.append($selectedHandle) ;
            $li.click(function(){
                $(this).toggleClass("on") ;
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果只能上传一张，就要先清空之前的清单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if( ! opts.multiple) $(container).find(".uploader-files").empty() ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            吧单个缩略图贴到容器下
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(container).find(".uploader-files").append($li) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            最后显示删除按钮
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(container).find(".remove-handle").css({ "display" : "inline-block" }) ;
        }
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     upload默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.upload.defaults = {        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        可以接受的文件扩展名列表，用半角逗号隔开，默认是上传图片，值为：image/jpg,image/jpeg,image/png,image/gif
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "accept" : "image/jpg,image/jpeg,image/png,image/gif" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否可以上传多张，注意：
        这个插件上传多张多次选择一张来实现，不会通过一次性选择多张来实现
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "multiple" : false
    } ;
})(jQuery) ;