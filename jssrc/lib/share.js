/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：有房有客H5站
 2. 页面名称：WechatShare
 3. 作者：zhaohuagang@lifang.com
 4. 备注：对api的依赖：jQuery
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function WechatShare(conf) {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    分享的标题
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.title = conf.title || "" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    分享的内容
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.content = conf.content || "" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    分享的链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.linkUrl = window.location.href ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    分享的图片
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.imgUrl = conf.imgUrl || "" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    全局的环境地址
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.environment = conf.environment || "prod" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    api接口地址前缀
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.apiPrefix = "" ;    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    接口的地址,根据不同的环境进行配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    if (this.environment === "test") this.apiPrefix = "//10.0.18.79:8134/" ;
    else if (this.environment === "beta") this.apiPrefix = "//wechat-beta.wkzf.com/" ;
    else if (this.environment === "sim") this.apiPrefix = "//wechat.sim.wkzf/" ;
    else if (this.environment === "prod") this.apiPrefix = "//wechat.wkzf.com/" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    拼接微信分享地址
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.apiUrl = this.apiPrefix + "wx_js_sdk_sign.rest??wechatCode=1000001" ; 
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    请求接口获取微信配置，最后绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.sendRequest() ;
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
WechatShare.prototype.wx_onMenuShareTimeline = function() {
    wx.onMenuShareTimeline({
        title : this.title ,
        link : this.linkUrl ,
        imgUrl : this.imgUrl ,
        trigger : function(res) {} ,
        success : function(res) {} ,
        cancel : function(res) {} ,
        fail : function(res) {}
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
监听“发送给朋友”按钮点击
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
WechatShare.prototype.wx_onMenuShareAppMessage = function() {
    wx.onMenuShareAppMessage({
        title : this.title , // 分享标题
        desc : this.content , // 分享描述
        link : this.linkUrl , // 分享链接
        imgUrl : this.imgUrl , // 分享图标
        type : '' , // 分享类型,music、video或link，不填默认为link
        dataUrl : '' , // 如果type是music或video，则要提供数据链接，默认为空
        success : function() {
            // 用户确认分享后执行的回调函数                
        } ,
        cancel : function() {
            // 用户取消分享后执行的回调函数               
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
发送请求
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
WechatShare.prototype.sendRequest = function() {
    var classSelf = this ;
    $.ajax({
        url : this.apiUrl ,
        type : "GET" ,
        data : { requestUrl : window.location.href } ,
        dataType : "jsonp" ,        
        error : function(e) {
            //console.log("error" + e);
        } ,
        success : function(result) {
            var data = result.data ;
            wx.config({
                debug : false , // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId : data.appid , // 必填，企业号的唯一标识，此处填写企业号corpid
                timestamp : data.timestamp , // 必填，生成签名的时间戳
                nonceStr : data.nonce_str , // 必填，生成签名的随机串
                signature : data.signature , // 必填，签名，见附录1
                jsApiList : ['onMenuShareAppMessage', 'onMenuShareTimeline'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            请求完成之后执行ready方法
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            wx.ready(function() {
                wx.showOptionMenu() ;
                classSelf.wx_onMenuShareTimeline() ; //  监听“分享到朋友圈
                classSelf.wx_onMenuShareAppMessage() ; //  监听“发送给朋友”按钮点击
            }) ;
        }
    }) ;
} ;