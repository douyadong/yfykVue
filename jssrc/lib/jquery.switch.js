/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房移动端FE-MVC框架
 2. 页面名称：jquery.switch (jQuery扩展方法 - 开关)
 3. 作者：zhaohuagang@lifang.com
 4. 实例：
    
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.switch = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个switch加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.switch.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            创建switch插件dom节点
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.switch.generate(this) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            将槽位容器和槽内弹珠引用起来方便使用
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            var $slot = $(this).find(".switch-slot") ;
            var switchMarbles = $slot.find(".switch-marbles")[0] ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            将槽位容器和槽内弹珠引用起来方便使用
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
            var location = 0 ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            侦测槽内弹珠在touchstart的时候在槽位容器中的位置是在左边还是右边，以方便确定是在左滑还是右滑
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
            switchMarbles.addEventListener("touchstart", function(evt){
                evt.preventDefault() ;  //阻止触摸时浏览器的缩放、滚动条滚动等
                location = parseInt($(switchMarbles).css("left"), 10) ;
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            由于手机浏览器内核都是支持W3C标准事件模型的，所以都可以用addEventListener和removeEventListener来绑定和解绑事件监听 
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/           
            switchMarbles.addEventListener("touchend", function(evt){
                evt.preventDefault() ;  //阻止触摸时浏览器的缩放、滚动条滚动等                
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                得到手指触摸结束的时候的坐标点
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
                var endX = parseFloat(evt.touches[0].pageX) ;                
                 var threshoud = $slot.width() / 2 ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                原则是
                1. 如果switch关闭状态(也就是弹珠在槽位左侧)，手指触摸结束的时候的坐标点减去槽位X坐标如果大于槽位宽度的一般，就切换到打开状态，否则不动
                2. 如果switch处于打开状态(也就是弹珠在槽位右侧)，手指触摸结束的时候的坐标点减去槽位最右边X坐标如果大于槽位宽度的一般，就切换到关闭状态，否则不动
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/               
                if(location === 0) {
                    var moveDistance = endX - $slot.offset().left ;
                    if(moveDistance >= threshoud) {
                        $(switchMarbles).animate({
                            "left" : $slot.width() - $(switchMarbles).width()
                        }, 200, "linear", function(){
                            $slot.addClass("on") ;
                            if(opts.changeInterface) opts.changeInterface("on") ;
                        }) ;
                    }
                }
                else {
                    var moveDistance = endX - $slot.offset().left - $slot.width() ;
                    if(moveDistance <= -threshoud) {
                        $(switchMarbles).animate({
                            "left" : 0
                        }, 200, "linear", function(){
                            $slot.removeClass("on") ;
                            if(opts.changeInterface) opts.changeInterface("off") ;
                        }) ;
                    }
                }
            }) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     创建switch插件dom节点
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.switch.generate = function(container) {
        $(container).append("<div class=\"wkzf-switch switch-slot\"><div class=\"wkzf-switch switch-marbles\"></div></div>") ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     switch默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.switch.defaults = {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        当改变状态的时候触发的接口事件，这个接口事件是以打开(on)或者关闭(off)状态值为参数
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "changeInterface" : null
    } ;
})(jQuery) ;