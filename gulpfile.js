"use strict";

var gulp = require("gulp");
var clean = require("gulp-clean");
var less = require("gulp-less");
var uglify = require("gulp-uglify");
var concat = require("gulp-concat");
var jshint = require("gulp-jshint");
var rename = require("gulp-rename");
var minifyCss = require("gulp-minify-css");
var gulpSequence = require('gulp-sequence');
var plumber = require('gulp-plumber');
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
需要编译到css目录下对应目录的less文件路径定义
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
var compileLessPath = [
    "less/app.less" ,
    "less/*/*.less" ,
    "!less/components/*.less" ,
    "!less/mixins/*.less" ,
    "!less/variables/*.less"
] ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
需要编译到js目录下对应目录的jssrc目录源文件路径定义
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
var concatJsPath = [    
    "jssrc/lib/*.js"    
] ;
var compileJsPath = [    
    "jssrc/*/*.js" ,
    "!jssrc/lib/*.js"
] ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义清空编译目录(css | js)任务
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
gulp.task("clean", function() {
    return gulp.src([
            "css",
            "js"
        ], {
            read: false
        })
        .pipe(clean());
}) ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义对less编译的任务
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
gulp.task("compileLess", function() {
    return gulp.src(compileLessPath)
        .pipe(less())
        .pipe(minifyCss())
        .pipe(rename({
            suffix : ".min"
        }))
        .pipe(gulp.dest("css"));
}) ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义对核心js合并的任务
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
gulp.task("concatUglifyToApp", function() {
    return gulp.src(concatJsPath)
        .pipe(plumber())
        .pipe(concat("app.min.js"))
        .pipe(uglify())
        .pipe(gulp.dest("js"));
}) ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义编译js的任务
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
gulp.task("compileJs", function() {
    return gulp.src(compileJsPath)
        .pipe(plumber())
        .pipe(uglify())
        .pipe(rename({
            suffix : ".min"
        }))
        .pipe(gulp.dest("js"))
}) ;
/*-----------------------------------------------------------------------------------------------------------
定义watch任务
-----------------------------------------------------------------------------------------------------------*/
gulp.task('watch', function() {
    gulp.watch('less/**/**.less', ["compileLess"]) ;
    gulp.watch(concatJsPath, ["concatUglifyToApp"]) ;
    gulp.watch(compileJsPath, ["compileJs"]) ;
}) ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义复合任务方便gulp命令一步执行，包括：
1. 清空编译目录
2. 编译less
3. 合并压缩相应文件到app.min.js
4. 编译脚本
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
gulp.task('default', ['watch']) ;
gulp.task('build', gulpSequence('clean', 'compileLess', 'concatUglifyToApp', 'compileJs'))


